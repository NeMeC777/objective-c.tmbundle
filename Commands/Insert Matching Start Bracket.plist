<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>beforeRunningCommand</key>
	<string>nop</string>
	<key>command</key>
	<string>#!/usr/bin/env ruby
=begin
tested on:

fishsticks everyone
[obj fishsticks
[obj setThing:other thing]
[obj method:NSArray arrayWithObject:arg]
[obj method:value1 arg:NSArray arrayWithObject:someObject]
[obj setFish: fish thing: other thing]
[obj setFish: fish thing: [other thing]]
[obj setFish: other fish: thing]
fish = NSArray alloc
fish = [NSArray alloc] init
glPushName(self index)
fish=NSArray alloc

Enjoy the fishness.

Rob

=end

$line = ENV['TM_CURRENT_LINE']
$caret = ENV['TM_LINE_INDEX'].to_i

def message_context(string)
	mes = message string, false
	if mes
		[string[0, string.length - mes.length], string[((string.length - mes.length)), mes.length]]
	else
		[nil, nil]
	end
end

def message(string, check_brackets = true)
	out = ""
	if check_brackets
		b = string[/\]\s*$/]
		if b
			string = string[0, string.length - b.length]
			out = b + out
		else
			return nil
		end
	end
	sel = selector(string)
	if sel
		string = string[0, string.length - sel.length]
		rec = receiver(string)
		if rec
			string = string[0, string.length - rec.length]
			out = rec + sel + out
		else
			return nil
		end
	else
		return nil
	end
	if check_brackets
		b = string[/\[\s*$/]
		if b
			string = string[0, string.length - b.length]
			out = b + out
		else
			return nil
		end
	end
	out
end

def receiver(string)
	string[/[^\[\]\(\)\s\=\+\-\*\/,\\:]+\s*$/] || message(string)
	#string[/\w+\s*$/] || message(string)
end

def argument(string)
	arg = (string[/([\w]+\s*)+$/] || message(string))
# 	needs to handle arg list
# 	if arg
# 		
# 	end
end

def selector(string)
	arg = receiver string
	if arg
		string = string[0, string.length - arg.length]
		sel = string[/\w+:\s*$/]
		if sel
			sel + arg
		else
			arg
		end
	end
end

def balance_close_bracket(line)
	before_caret, after_caret = line[0..($caret - 1)], line[$caret..-1]
	start, rest = message_context before_caret
	if start.nil? or rest.nil? then
		line.gsub /^(\s*)(.+)$/, '\1[\2'
	else
		start + "[" + rest + (after_caret || "")
	end
end

def snippet_escape(str)
#	these characters have special meaning in snippets
	str.gsub(/[$`\\]/, '\\\\\0')
end

open_count = $line.count "["
close_count = $line.count "]"

left = $line[0...$caret]
left = balance_close_bracket left if open_count == close_count

right = $line[$caret..-1]

print "#{snippet_escape left}]${0}#{snippet_escape right}"
</string>
	<key>fallbackInput</key>
	<string>line</string>
	<key>input</key>
	<string>selection</string>
	<key>keyEquivalent</key>
	<string>]</string>
	<key>name</key>
	<string>Insert Matching Start Bracket</string>
	<key>output</key>
	<string>insertAsSnippet</string>
	<key>scope</key>
	<string>source.objc - string - comment, source.objc++ - string - comment</string>
	<key>uuid</key>
	<string>DB16585F-4D78-412B-B468-38AD54C254B5</string>
</dict>
</plist>
